import tkinter as tk
from tkinter import ttk
from voice_changer import VoiceChanger
import threading
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import numpy as np
import json
import os

class VoiceChangerGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Voice Changer")
        self.voice_changer = None
        self.load_config()
        self.setup_ui()
        self.setup_audio_monitor()
        
    def load_config(self):
        """Load configuration from file if it exists"""
        self.config = {
            'api_key': '',
            'voice_id': ''
        }
        config_path = 'config.json'
        if os.path.exists(config_path):
            try:
                with open(config_path, 'r') as f:
                    self.config = json.load(f)
            except Exception as e:
                print(f"Error loading config: {e}")
                
    def save_config(self):
        """Save configuration to file"""
        config_path = 'config.json'
        try:
            with open(config_path, 'w') as f:
                json.dump(self.config, f)
        except Exception as e:
            print(f"Error saving config: {e}")
        
    def setup_ui(self):
        frame = ttk.Frame(self.root, padding="10")
        frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # ElevenLabs API Key
        ttk.Label(frame, text="ElevenLabs API Key:").grid(row=0, column=0, padx=5, pady=5)
        self.api_key = ttk.Entry(frame, width=40, show="*")  # Hide API key
        self.api_key.insert(0, self.config.get('api_key', ''))
        self.api_key.grid(row=0, column=1, padx=5, pady=5)
        
        # Show/Hide API Key button
        self.show_api = tk.BooleanVar()
        ttk.Checkbutton(frame, text="Show", variable=self.show_api, 
                       command=self.toggle_api_visibility).grid(row=0, column=2)
        
        # Voice ID selection
        ttk.Label(frame, text="Voice ID:").grid(row=1, column=0, padx=5, pady=5)
        self.voice_id = ttk.Entry(frame, width=40)
        self.voice_id.insert(0, self.config.get('voice_id', ''))
        self.voice_id.grid(row=1, column=1, padx=5, pady=5)
        
        # Control buttons
        button_frame = ttk.Frame(frame)
        button_frame.grid(row=2, column=0, columnspan=3, pady=10)
        
        self.start_button = ttk.Button(button_frame, text="Start", command=self.start_voice_changer)
        self.start_button.pack(side=tk.LEFT, padx=5)
        
        self.stop_button = ttk.Button(button_frame, text="Stop", 
                                    command=self.stop_voice_changer, 
                                    state=tk.DISABLED)
        self.stop_button.pack(side=tk.LEFT, padx=5)
        
        # Save config button
        self.save_button = ttk.Button(button_frame, text="Save Settings", 
                                    command=self.save_settings)
        self.save_button.pack(side=tk.LEFT, padx=5)
        
        # Status indicator
        self.status_label = ttk.Label(frame, text="Status: Stopped")
        self.status_label.grid(row=3, column=0, columnspan=3, pady=5)
        
    def toggle_api_visibility(self):
        """Toggle API key visibility"""
        self.api_key.config(show="" if self.show_api.get() else "*")
        
    def save_settings(self):
        """Save current settings"""
        self.config['api_key'] = self.api_key.get()
        self.config['voice_id'] = self.voice_id.get()
        self.save_config()
        self.status_label.config(text="Status: Settings saved")
        
    # ... rest of the existing methods ...
